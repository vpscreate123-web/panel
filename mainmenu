#!/usr/bin/env bash
export LC_ALL=C.UTF-8
export LANG=C.UTF-8

set -u

# ---- COLORS ----
C=$'\033[36m'
G=$'\033[32m'
R=$'\033[31m'
B=$'\033[34m'
Y=$'\033[33m'
W=$'\033[97m'
P=$'\033[35m'
BLINK=$'\033[5m'
N=$'\033[0m'

# ---- TYPEWRITER EFFECT ----
typewriter() {
    text="$1"
    delay=0.005
    for ((i=0; i<${#text}; i++)); do
        printf "%s" "${text:$i:1}"
        sleep $delay
    done
    printf "\n"
}

# ---- PROGRESS BAR ----
progress_bar() {
    echo -e "${C}Initializing TYRKROX NODE...${N}"
    for i in {1..30}; do
        printf "${G}#${N}"
        sleep 0.03
    done
    echo ""
    for i in {0..100..10}; do
        printf "\r${Y}Loading System: $i%%%${N}"
        sleep 0.15
    done
    echo ""
    sleep 1
}

# ---- INTRO ----
intro() {
    clear
    echo -e "${P}"
    typewriter "‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó"
    typewriter "‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ïö‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù"
    typewriter "   ‚ñà‚ñà‚ïë    ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù "
    typewriter "   ‚ñà‚ñà‚ïë     ‚ïö‚ñà‚ñà‚ïî‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó "
    typewriter "   ‚ñà‚ñà‚ïë      ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó"
    typewriter "   ‚ïö‚ïê‚ïù      ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù"
    echo -e "${N}"
    echo ""
    typewriter "üíé TYRKROX NODE BOOTING..."
    sleep 1
    progress_bar
    clear
}

# ---- HEADER ----
header() {
    echo -e "${P}${BLINK}üíé TYRKROX NODE üíé${N}"
    echo -e "${Y}‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ${N}"
    echo ""
}

pause() {
    echo ""
    read -p "${W}Press [Enter] to return...${N}" dummy
}

# ---- PTERODACTYL MENU FUNCTION ----
ptero_menu() {
    while true; do
        clear
        echo "========================================="
        echo "   PTERODACTYL CONTROL CENTER v2.1"
        echo "========================================="
        echo ""
        echo "1) Install Panel"
        echo "2) Create User"
        echo "3) Update Panel"
        echo "4) Install SSL"
        echo "5) Uninstall Panel"
        echo "6) Back to Main Menu"
        echo ""
        read -p "Select option: " opt

        case $opt in
            1)
                bash <(curl -fsSL https://raw.githubusercontent.com/nobita329/ptero/main/ptero/panel/pterodactyl/install.sh)
                read -p "Press Enter..."
                ;;
            2)
                cd /var/www/pterodactyl 2>/dev/null && php artisan p:user:make
                read -p "Press Enter..."
                ;;
            3)
                cd /var/www/pterodactyl || { echo "Panel not installed!"; sleep 2; continue; }
                php artisan down
                curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
                tar -xzvf panel.tar.gz
                COMPOSER_ALLOW_SUPERUSER=1 composer install --no-dev --optimize-autoloader
                php artisan migrate --seed --force
                php artisan up
                read -p "Press Enter..."
                ;;
            4)
                bash <(curl -fsSL https://raw.githubusercontent.com/nobita329/ptero/main/ptero/panel/pterodactyl/ssl.sh)
                read -p "Press Enter..."
                ;;
            5)
                rm -rf /var/www/pterodactyl
                echo "Panel Removed."
                sleep 2
                ;;
            6)
                break
                ;;
            *)
                echo "Invalid option"
                sleep 1
                ;;
        esac
    done
}

# ---- START ----
intro

# ---- MAIN LOOP ----
while true; do
    clear
    header

    echo -e "${C} 1) ${W}Discord Server Link${N}"
    echo -e "${C} 2) ${W}Proxmox VE (Docker) Install üöÄ${N}"
    echo -e "${C} 3) ${W}VM/KVM Installer${N}"
    echo -e "${C} 4) ${W}Pterodactyl Panel Installer${N}"
    echo -e "${C} 5) ${W}Wings Installer${N}"
    echo -e "${C} 6) ${W}Blueprint + Addon Installer${N}"
    echo -e "${C} 7) ${W}installing Cloudflare${N}"
    echo -e "${C} 8) ${W}Tailscale VPN Installer${N}"
    echo -e "${R} 0) Exit${N}"

    echo ""
    read -p "${Y}Select an option [1-9]: ${N}" choice

    case $choice in
        1)
            echo -e "${G}https://discord.gg/2rYEHharqA${N}"
            pause
            ;;
        2)
            docker run -itd \
              --name proxmoxve \
              --hostname pve \
              --privileged \
              --cgroupns=host \
              --security-opt apparmor=unconfined \
              --security-opt seccomp=unconfined \
              -v /sys/fs/cgroup:/sys/fs/cgroup:rw \
              -v /lib/modules:/lib/modules:ro \
              -v /dev/fuse:/dev/fuse \
              -v /sys/kernel/debug:/sys/kernel/debug \
              -p 8006:8006 \
              --restart unless-stopped \
              rtedpro/proxmox:9.0.11
            pause
            ;;
        3)
            bash <(curl -fsSL https://raw.githubusercontent.com/vpscreate123-web/mainnemu/main/Mainmenu)
            pause
            ;;
        4)
            ptero_menu
            ;;
        5)#!/bin/bash
set -e

# ==================================================
#  TYRKROX WINGS FULL SUITE (INSTALL + CONFIG)
# ==================================================

# ---------------- COLORS ----------------
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
MAGENTA='\033[1;35m'
WHITE='\033[1;37m'
NC='\033[0m'

CHECK="‚úî"
CROSS="‚úñ"
ARROW="‚ûú"

# ---------------- UI ----------------
msg() { echo -e "${CYAN}${ARROW} $1${NC}"; }
ok()  { echo -e "${GREEN}${CHECK} $1${NC}"; }
err() { echo -e "${RED}${CROSS} $1${NC}"; }

# ---------------- ROOT CHECK ----------------
if [ "$EUID" -ne 0 ]; then
    err "Run as root"
    exit 1
fi

# ==================================================
# 1Ô∏è‚É£ WINGS INSTALLER
# ==================================================
install_wings() {

clear
echo -e "${BLUE}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
echo -e "${BLUE}‚ïë${NC}${CYAN}  PTERODACTYL WINGS INSTALLER  ${NC}${BLUE}‚ïë${NC}"
echo -e "${BLUE}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"

# Docker
msg "Installing Docker"
curl -sSL https://get.docker.com/ | CHANNEL=stable bash >/dev/null 2>&1
systemctl enable --now docker >/dev/null 2>&1
ok "Docker Ready"

# Directory
msg "Creating Directory"
mkdir -p /etc/pterodactyl
ok "Directory Ready"

# Detect Arch
ARCH=$(uname -m)
[ "$ARCH" = "x86_64" ] && ARCH="amd64" || ARCH="arm64"

msg "Downloading Wings"
curl -L -o /usr/local/bin/wings \
https://github.com/pterodactyl/wings/releases/latest/download/wings_linux_$ARCH \
>/dev/null 2>&1

chmod +x /usr/local/bin/wings
ok "Wings Installed"

# Service
msg "Creating Service"
cat <<EOF > /etc/systemd/system/wings.service
[Unit]
Description=Pterodactyl Wings
After=docker.service
Requires=docker.service

[Service]
User=root
WorkingDirectory=/etc/pterodactyl
ExecStart=/usr/local/bin/wings
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable wings >/dev/null 2>&1
ok "Service Configured"
}

# ==================================================
# 2Ô∏è‚É£ CONFIGURATOR
# ==================================================
configure_wings() {

clear
echo -e "${MAGENTA}‚ö° WINGS CONFIGURATOR${NC}"
echo ""

read -p "Node UUID: " UUID
read -p "Token ID: " TOKEN_ID
read -p "Token Key: " TOKEN
read -p "API Port (default 8080): " API_PORT
read -p "Panel URL (https://panel.domain.com): " REMOTE

[ -z "$API_PORT" ] && API_PORT=8080

mkdir -p /etc/pterodactyl

cat <<CFG > /etc/pterodactyl/config.yml
debug: false
uuid: ${UUID}
token_id: ${TOKEN_ID}
token: ${TOKEN}
api:
  host: 0.0.0.0
  port: ${API_PORT}
  ssl:
    enabled: false
system:
  data: /var/lib/pterodactyl/volumes
remote: '${REMOTE}'
CFG

ok "Config Created"

msg "Restarting Wings"
systemctl restart wings

if systemctl is-active --quiet wings; then
    ok "Wings is Running üöÄ"
else
    err "Failed to start. Check: journalctl -u wings -n 20"
fi
}

# ==================================================
# RUN FLOW
# ==================================================
install_wings
configure_wings

echo ""
echo -e "${GREEN}üî• FULL INSTALLATION COMPLETE üî•${NC}"
echo ""
            pause
            ;;
        6) #!/bin/bash

# ==================================================
#  BLUEPRINT v3.0 AUTO-RUN (INSTALL + FIX)
# ==================================================

# --- COLORS ---
R="\e[31m"; G="\e[32m"; Y="\e[33m"; B="\e[34m"; C="\e[36m"; W="\e[37m"; N="\e[0m"

# --- CONFIG ---
PT_DIR="/var/www/pterodactyl"

# --- 1. ROOT CHECK ---
if [ "$EUID" -ne 0 ]; then
    echo -e "${R}‚ùå Error: Please run as root (sudo bash $0)${N}"
    exit 1
fi

# --- 2. HEADER ---
clear
echo -e "${B}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${N}"
echo -e "${B}‚ïë${W}    üöÄ BLUEPRINT v3.0 AUTO-INSTALLER & FIXER          ${B}‚ïë${N}"
echo -e "${B}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${N}"
echo
echo -e "${Y}‚ö†Ô∏è  Target Directory:${N} ${C}$PT_DIR${N}"
echo -e "${W}Starting automated sequence in 3 seconds...${N}"
sleep 3

# --- 3. SYSTEM PREP ---
echo -e "\n${B}[1/7] Checking Environment...${N}"
if [ ! -d "$PT_DIR" ]; then
    echo -e "${R}‚ùå Pterodactyl directory not found!${N}"
    exit 1
fi
echo -e "${G}‚úî Pterodactyl found.${N}"

echo -e "\n${B}[2/7] Installing Dependencies...${N}"
apt update -y -q
apt install -y curl wget unzip ca-certificates git gnupg zip -q
echo -e "${G}‚úî System packages ready.${N}"

# --- 4. NODE.JS SETUP ---
echo -e "\n${B}[3/7] Setting up Node.js 20 & Yarn...${N}"
mkdir -p /etc/apt/keyrings
curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" > /etc/apt/sources.list.d/nodesource.list
apt update -y -q
apt install -y nodejs -q
npm i -g yarn
echo -e "${G}‚úî Node environment ready.${N}"

# --- 5. BLUEPRINT SETUP ---
echo -e "\n${B}[4/7] Downloading Blueprint Framework...${N}"
cd "$PT_DIR"
DOWNLOAD_URL=$(curl -s https://api.github.com/repos/BlueprintFramework/framework/releases/latest | grep 'browser_download_url' | grep 'release.zip' | cut -d '"' -f 4)
wget -q "$DOWNLOAD_URL" -O "$PT_DIR/release.zip"
unzip -o -q release.zip
echo -e "${G}‚úî Files extracted.${N}"

echo -e "\n${B}[5/7] Configuring Blueprint...${N}"
cat <<EOF > "$PT_DIR/.blueprintrc"
WEBUSER="www-data";
OWNERSHIP="www-data:www-data";
USERSHELL="/bin/bash";
EOF
chmod +x "$PT_DIR/blueprint.sh"
echo -e "${G}‚úî Configuration applied.${N}"

# --- 6. INSTALLATION ---
echo -e "\n${B}[6/7] Running Internal Installer...${N}"
# We execute the blueprint script. If it asks for prompts, this usually just runs through.
bash "$PT_DIR/blueprint.sh"

# --- 7. AUTO-FIX (THE v3.0 FEATURE) ---
echo -e "\n${B}[7/7] Running Auto-Fix Diagnostics...${N}"

echo -e "   ${Y}‚ûú Fixing Permissions...${N}"
chown -R www-data:www-data "$PT_DIR"
find "$PT_DIR" -type d -exec chmod 755 {} \;
find "$PT_DIR" -type f -exec chmod 644 {} \;
chmod +x "$PT_DIR/artisan" "$PT_DIR/blueprint.sh" 2>/dev/null

echo -e "   ${Y}‚ûú Ensuring Yarn Dependencies...${N}"
# Quietly ensure dependencies are installed
yarn install --production --silent

echo -e "   ${Y}‚ûú Clearing Panel Cache...${N}"
php artisan view:clear
php artisan config:clear
php artisan route:clear

# --- COMPLETION ---
echo -e "\n${G}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${N}"
echo -e "${G}   üéâ COMPLETED SUCCESSFULLY!${N}"
echo -e "${W}   Blueprint is installed, permissions are fixed,${N}"
echo -e "${W}   and caches have been cleared.${N}"
echo -e "${G}‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê${N}"
            pause
            ;;
        7)#!/bin/bash

# ==================================================
#  CLOUDFLARE COMMANDER v3.0
# ==================================================

# --- THEME & COLORS ---
# Using distinct neon colors for a modern terminal look
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# --- ICONS ---
ICON_RUN="${GREEN}‚óè${NC}"
ICON_STOP="${RED}‚óè${NC}"
ICON_WAIT="${YELLOW}‚óå${NC}"
ICON_CHECK="${GREEN}‚úî${NC}"
ICON_ERR="${RED}‚úñ${NC}"
ICON_ARROW="${PURPLE}‚ûú${NC}"

# --- HELPER FUNCTIONS ---

# Draw a centered header with dynamic status
show_header() {
    clear
    # System & Service Checks
    local s_status="${GRAY}NOT INSTALLED${NC}"
    local s_pid="${GRAY}---${NC}"
    local s_uptime="${GRAY}---${NC}"
    local arch=$(dpkg --print-architecture 2>/dev/null || uname -m)

    if command -v cloudflared &>/dev/null; then
        if systemctl is-active --quiet cloudflared; then
            s_status="${GREEN}ACTIVE (RUNNING)${NC}"
            s_pid="${WHITE}$(pgrep -x cloudflared)${NC}"
            s_uptime="$(systemctl show -p ActiveEnterTimestamp cloudflared | cut -d'=' -f2 | cut -d' ' -f2-3)"
        else
            s_status="${RED}INACTIVE (STOPPED)${NC}"
        fi
    fi

    # UI Banner
    echo -e "${PURPLE} ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${PURPLE} ‚îÇ${NC}              ${WHITE}CLOUDFLARED TUNNEL MANAGER${NC}                  ${PURPLE}‚îÇ${NC}"
    echo -e "${PURPLE} ‚îÇ${NC}                 ${GRAY}v3.0 | Premium Edition${NC}                   ${PURPLE}‚îÇ${NC}"
    echo -e "${PURPLE} ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo ""
    
    # Dashboard Card
    echo -e "${CYAN}  SYSTEM STATUS ${GRAY}‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo -e "  ${GRAY}‚óè${NC} Architecture : ${WHITE}$arch${NC}"
    echo -e "  ${GRAY}‚óè${NC} Service Stat : $s_status"
    echo -e "  ${GRAY}‚óè${NC} Process ID   : $s_pid"
    echo -e "  ${GRAY}‚óè${NC} Last Started : ${CYAN}$s_uptime${NC}"
    echo -e "${GRAY} ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    echo ""
}

# Pretty print step messages
step_msg() {
    echo -e "  ${CYAN}[INFO]${NC} $1..."
}

success_msg() {
    echo -e "  ${GREEN}[DONE]${NC} $1"
}

error_msg() {
    echo -e "  ${RED}[FAIL]${NC} $1"
}

# --- CORE LOGIC ---

install_cf() {
    show_header
    echo -e "${WHITE}  STARTING INSTALLATION SEQUENCE${NC}"
    echo -e "${GRAY}  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ${NC}"
    sleep 1

    # 1. Setup Repo
    step_msg "Configuring Cloudflare Repository"
    sudo mkdir -p --mode=0755 /usr/share/keyrings
    curl -fsSL https://pkg.cloudflare.com/cloudflare-main.gpg | sudo tee /usr/share/keyrings/cloudflare-main.gpg >/dev/null
    echo 'deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared any main' | sudo tee /etc/apt/sources.list.d/cloudflared.list >/dev/null
    success_msg "Repository Added"

    # 2. Install Package
    step_msg "Updating APT & Installing Binary"
    sudo apt-get update -qq >/dev/null
    sudo apt-get install -y cloudflared -qq >/dev/null 2>&1
    
    if command -v cloudflared &>/dev/null; then
        success_msg "Cloudflared Binary Installed"
    else
        error_msg "Binary Installation Failed"
        read -p "Press Enter to return..."
        return
    fi

    # 3. Clean Old Service
    if systemctl list-units --type=service | grep -q cloudflared; then
        step_msg "Removing conflicting services"
        sudo cloudflared service uninstall >/dev/null 2>&1
        success_msg "Cleaned old service"
    fi

    # 4. Token Input UI
    echo ""
    echo -e "${YELLOW}  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê${NC}"
    echo -e "${YELLOW}  ‚îÇ                    ACTION REQUIRED                     ‚îÇ${NC}"
    echo -e "${YELLOW}  ‚îÇ${NC} Paste your Tunnel Token below.${NC}                         ${YELLOW}‚îÇ${NC}"
    echo -e "${YELLOW}  ‚îÇ${NC} ${GRAY}(You can paste the whole 'sudo cloudflared...' cmd)${NC}    ${YELLOW}‚îÇ${NC}"
    echo -e "${YELLOW}  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò${NC}"
    echo ""
    echo -ne "${PURPLE}  ‚û§ INPUT TOKEN:${NC} " 
    read USER_TOKEN

    # Logic to clean token (removes command if pasted)
    CLEAN_TOKEN=$(echo "$USER_TOKEN" | sed 's/sudo cloudflared service install //g' | sed 's/cloudflared service install //g' | xargs)

    if [[ -z "$CLEAN_TOKEN" ]]; then
        error_msg "Token cannot be empty!"
        read -p "Press Enter to return..."
        return
    fi

    # 5. Register & Start
    step_msg "Registering Tunnel Service"
    sudo cloudflared service install "$CLEAN_TOKEN"
    
    echo ""
    echo -e "${CYAN}  Waiting for service to initialize...${NC}"
    
    # Progress Bar Animation
    for i in {1..20}; do echo -ne "‚ñì"; sleep 0.1; done
    echo ""
    
    if systemctl is-active --quiet cloudflared; then
        echo ""
        echo -e "${GREEN}  SUCCESS: Tunnel is Online & Stable!${NC}"
    else
        echo ""
        echo -e "${RED}  ERROR: Service failed to start.${NC}"
        echo -e "${GRAY}  Debug command: sudo journalctl -u cloudflared -f${NC}"
    fi

    echo ""
    read -p "  Press [Enter] to return to menu..."
}

uninstall_cf() {
    show_header
    echo -e "${RED}  WARNING: DESTRUCTIVE ACTION${NC}"
    echo -e "${GRAY}  This will remove the tunnel service and the binary.${NC}"
    echo ""
    echo -ne "${RED}  Are you sure you want to proceed? (y/N): ${NC}"
    read confirm
    
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        echo ""
        step_msg "Stopping Service"
        sudo cloudflared service uninstall >/dev/null 2>&1
        
        step_msg "Removing Binary"
        sudo apt-get remove -y cloudflared -qq >/dev/null 2>&1
        
        step_msg "Cleaning Configuration"
        sudo rm -f /etc/apt/sources.list.d/cloudflared.list
        sudo rm -f /usr/share/keyrings/cloudflare-main.gpg
        
        echo ""
        success_msg "Cloudflared Completely Removed."
    else
        echo -e "\n  ${GRAY}Operation Cancelled.${NC}"
    fi
    sleep 2
}

# --- MAIN MENU LOOP ---

while true; do
    show_header
    
    echo -e "  ${WHITE}AVAILABLE OPERATIONS:${NC}"
    echo -e "  ${GREEN}[1]${NC} Install or Update Tunnel    ${GRAY}(Auto-Fix)${NC}"
    echo -e "  ${RED}[2]${NC} Uninstall Completely        ${GRAY}(Remove All)${NC}"
    echo -e "  ${GRAY}[0]${NC} Exit Dashboard"
    echo ""
    echo -ne "${PURPLE}  root@cloudflared:~# ${NC}"
    read choice

    case $choice in
        1) install_cf ;;
        2) uninstall_cf ;;
        0) clear; exit ;;
        *) echo -e "  ${RED}Invalid Option${NC}"; sleep 1 ;;
    esac
done
            pause
            ;;
        8)
            curl -fsSL https://tailscale.com/install.sh | sh
            pause
            ;;
        0)
            echo -e "${G}TYRKROX NODE ROCKS üòéüî•${N}"
            sleep 1
            exit 0
            ;;
        *)
            echo -e "${R}Invalid Option!${N}"
            sleep 1.5
            ;;
    esac
done
